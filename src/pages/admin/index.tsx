import Head from "next/head";
import { Admin } from "@/components/Admin";
import { useManagement } from "@/context/ManagementContext";
import Publications from "@/components/Settings/Publications";
import Drafts from "@/components/Settings/Drafts";
import Disabled from "@/components/Settings/Disabled";
import Articles from "@/components/Manager/Articles";
import Authors from "@/components/Manager/Authors";
import { GetServerSideProps } from "next";
import { useMemo, useEffect, useState } from "react";
import { useQuery } from "react-query";

export interface Article {
  id: string;
  title: string;
  subtitle: string;
  text: string;
  category: string;
  author: string;
  created_at: string;
  state: string;
  
}

interface AdminProps {
  articles: Article[];
}

export default function Adm({}: AdminProps) {
    const [ articles, setArticles ] = useState<Article[] | null>(null)
    const [ disabled, setDisabled ] = useState<Article[] | null>(null)
    const [ drafts, setDrafts ] = useState<Article[] | null>(null)
    // const { data, isLoading, error } = useQuery('articles', async () => {
    //   const response = await fetch("http://localhost:3000/api/articles")
    //   const data = response.json()
      
    //   return data
    // })
    useEffect(() => {
      fetch("/api/articles")
      .then(res => res.json())
      .then(json => {
        const pub = json.articles.filter(article => article.state === "active")
        const disabled = json.articles.filter(article => article.state === "inactive")
        const drafts = json.articles.filter(article => article.state === "draft")
        setArticles(pub)
        setDisabled(disabled)
        setDrafts(drafts)
      })
    }, [])
    
    
    const PublicationsMemo = useMemo(() => <Publications articles={articles ?? null}/>, [articles])
    const DraftsMemo = useMemo(() => <Drafts articles={drafts ?? null}/>, [drafts])
    const DisabledMemo = useMemo(() => <Disabled articles={disabled ?? null}/>, [disabled])
    const AuthorsMemo = useMemo(() => <Authors/>, [])
    const ArticlesMemo = useMemo(() => <Articles />, [])
    
  const { navigation } = useManagement()

    return (
      <>
        <Head>
            <title>Admin | ARTechCMS</title>
            <meta name="description" content="Generated by create next app" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <link rel="icon" href="/favicon.ico" />
        </Head>
        <Admin>
            {
            navigation === "" ? PublicationsMemo : 
            navigation === "drafts" ? DraftsMemo: 
            navigation === "disabled" ? DisabledMemo: 
            navigation === "authors" ? AuthorsMemo : 
            navigation === "articles" ? ArticlesMemo : null
            }
        </Admin>
      </>
    )
  }

export const getServerSideProps: GetServerSideProps = async ({req, res, params}) => {
  
  let hierarchy = "admin" 
  if (hierarchy !== "admin") {
    return {
      redirect: {
        destination: '/author',
        permanent: true
      }
    }
  }
  
  return {
    props: {
      //articles
    }
  }
}